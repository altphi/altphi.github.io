<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>2025-11-24_tech</title>
  <meta property="og:title" content="2025-11-24_tech">
  <meta property="og:type" content="article">
  <meta property="og:url" content="https://log.j38.uk/2025-11-24_tech.html">
  <meta property="og:description" content="There are many ways to import modules with ESM. Some ways allow for testing frameworks to intercept and mock methods from these modules, while others do not. Tw...">
  <meta name="twitter:card" content="summary">
  <link rel="icon" href="/favicon.svg" type="image/svg+xml">
  <link rel="stylesheet" href="style.css?v=mlgn6zu8">
  <link rel="alternate" type="application/rss+xml" title="RSS" href="/feed.xml">
</head>
<body>
  <nav>
    <a href="/">‚Üê All posts</a>
  </nav>
  <main>
    <article>
      <header>
        <!-- <h1>2025-11-24_tech</h1> -->
        <!-- <div class="tags"><span class="tag">tech</span></div> -->
      </header>
      <div class="content">
        <p>There are many ways to import modules with ESM.  Some ways allow for testing frameworks to intercept and mock methods from these modules, while others
do not.</p>
<p>Two methods I use most often are:</p>
<pre><code class="language-typescript">// named imports (destructured into method names}
import { fnUsedAsReal, fnToBeMocked } from &quot;file.ts&quot;;
</code></pre>
<p>and</p>
<pre><code class="language-typescript">// namespace import (or star-import)
import * as File1Module from &quot;./file.ts&quot;;
</code></pre>
<p>Namespace imports are required for vitest to be able to spy/mock dynamically.</p>
<pre><code class="language-typescript">vi.spyOn(File1Module, &quot;fnToBeMocked&quot;).mockResolvedValue([&quot;123123&quot;, &quot;123124&quot;, &quot;123125&quot;]);
</code></pre>
<hr>
<p>The biggest gotcha I&#39;ve found in upgrading from <a href="https://jestjs.io/">jest</a> to <a href="https://vitest.dev/">vitest</a> is that if <em>any</em>
of the mocked methods are called internally within its own module, the mock does
not work. e.g.</p>
<p>You have a test in <code>file.test.ts</code>.
It imports all methods from <code>file.service.ts</code> -&gt; <code>import * as MyService from &#39;file.service.ts&#39;;</code>
You mock a method <code>function1</code> so you can test it... but <em>inside</em> file.service.ts
there are references/calls to <code>function1</code>, the mock will not work.</p>
<p>The workaround is simply to move anything that has to be mocked to its own file.
iow for the example above, both the test file and the service file will import
<code>function1</code> from a third file, and the mock will work. This, in my case, is
mostly fine as the internal calls are almost all to database functions that make
sense to be organized into their own file anyway.</p>
<hr>

      </div>
    </article>
  </main>
  <script src="main.js?v=mlgn6zu8"></script>
</body>
</html>
